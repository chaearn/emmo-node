const express = require('express');
const dotenv = require('dotenv');
const cors = require('cors');
const axios = require('axios');
const { createClient } = require('@supabase/supabase-js');

dotenv.config();

const app = express();
const port = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

// Supabase init
const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_KEY);

// Root route
app.get('/', (req, res) => {
  res.send('âœ… Emmo backend is running!');
});

// Analyze conversation
app.post('/emmo-chat', async (req, res) => {
  const { line_id, chapter_id = 1, messages } = req.body;

  // à¹‚à¸«à¸¥à¸” scenario à¸ˆà¸²à¸ Supabase
  const { data: scenario, error } = await supabase
    .from('scenarios')
    .select('*')
    .eq('chapter_id', chapter_id)
    .single();

  if (error || !scenario) {
    return res.status(400).json({ error: 'à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹‚à¸«à¸¥à¸” scenario à¹„à¸”à¹‰' });
  }

  // à¹‚à¸«à¸¥à¸” reference phrases
  const { data: referencePhrases, error: phrasesError } = await supabase
    .from('phrases_lib')
    .select('*');

  if (phrasesError) {
    return res.status(500).json({ error: 'à¹‚à¸«à¸¥à¸”à¸„à¸¥à¸±à¸‡ phrase à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ' });
  }

  // à¹€à¸•à¸£à¸µà¸¢à¸¡ Prompt à¸ªà¸³à¸«à¸£à¸±à¸š GPT
  const prompt = `
à¸„à¸¸à¸“à¸„à¸·à¸­ Emmo Coach à¹‚à¸„à¹‰à¸Šà¸œà¸¹à¹‰à¸«à¸à¸´à¸‡à¸ªà¸²à¸¢à¹ƒà¸ˆà¸”à¸µ à¸‚à¸µà¹‰à¹€à¸¥à¹ˆà¸™ à¹à¸¥à¸°à¹€à¸‚à¹‰à¸²à¸­à¸à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆ  
à¹€à¸˜à¸­à¹€à¸›à¹‡à¸™à¸ªà¹ˆà¸§à¸™à¸«à¸™à¸¶à¹ˆà¸‡à¸‚à¸­à¸‡à¹à¸­à¸›à¸Šà¸·à¹ˆà¸­ â€œEmmoâ€ â€” à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¡à¸·à¸­à¸—à¸µà¹ˆà¸Šà¹ˆà¸§à¸¢à¹ƒà¸«à¹‰à¸„à¸™à¸à¸¶à¸à¸žà¸¹à¸”à¸„à¸¸à¸¢à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸«à¹‡à¸™à¸­à¸à¹€à¸«à¹‡à¸™à¹ƒà¸ˆ  
à¹‚à¸”à¸¢à¹€à¸‰à¸žà¸²à¸°à¹ƒà¸™à¸ªà¸–à¸²à¸™à¸à¸²à¸£à¸“à¹Œà¸—à¸µà¹ˆà¹€à¸žà¸·à¹ˆà¸­à¸™à¸‚à¸­à¸‡à¹€à¸‚à¸²à¸à¸³à¸¥à¸±à¸‡à¸£à¸¹à¹‰à¸ªà¸¶à¸à¹à¸¢à¹ˆ à¸­à¹ˆà¸­à¸™à¹„à¸«à¸§ à¸«à¸£à¸·à¸­à¹€à¸¨à¸£à¹‰à¸² à¸«à¸£à¸·à¸­à¹à¸¡à¹‰à¸à¸£à¸°à¸—à¸±à¹ˆà¸‡à¸¡à¸µà¸„à¸§à¸²à¸¡à¹€à¸ªà¸µà¹ˆà¸¢à¸‡à¸—à¸µà¹ˆà¸ˆà¸°à¸—à¸³à¸£à¹‰à¸²à¸¢à¸•à¸±à¸§à¹€à¸­à¸‡

à¸šà¸—à¸ªà¸™à¸—à¸™à¸²à¸™à¸µà¹‰à¹€à¸›à¹‡à¸™à¸à¸²à¸£à¸ˆà¸³à¸¥à¸­à¸‡à¸ªà¸–à¸²à¸™à¸à¸²à¸£à¸“à¹Œ (simulation) à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ Emmo à¸—à¸µà¹ˆà¸ªà¸§à¸¡à¸šà¸—à¸šà¸²à¸—à¹€à¸›à¹‡à¸™ â€œà¹€à¸­à¸¡â€ à¹€à¸žà¸·à¹ˆà¸­à¸™à¸ªà¸¡à¸¡à¸•à¸´à¸—à¸µà¹ˆà¸à¸³à¸¥à¸±à¸‡à¸­à¹ˆà¸­à¸™à¹„à¸«à¸§à¸­à¸¢à¸¹à¹ˆ  
à¸à¸±à¸š â€œuserâ€ à¸„à¸™à¸—à¸µà¹ˆà¸à¸³à¸¥à¸±à¸‡à¸à¸¶à¸à¸­à¸¢à¸¹à¹ˆà¸à¸±à¸š Emmo  
à¹‚à¸”à¸¢à¹€à¸™à¹‰à¸™à¸à¸²à¸£à¸à¸¶à¸à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸à¸²à¸£à¹ƒà¸Šà¹‰ â€œà¸„à¸³à¸žà¸¹à¸”à¸—à¸µà¹ˆà¹€à¸«à¹‡à¸™à¹ƒà¸ˆâ€, â€œà¹‚à¸—à¸™à¹€à¸ªà¸µà¸¢à¸‡à¸—à¸µà¹ˆà¸›à¸¥à¸­à¸”à¸ à¸±à¸¢â€, â€œà¸§à¸´à¸˜à¸µà¸žà¸¹à¸”à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸„à¸£â€, tone of speech, empathy, à¹à¸¥à¸°à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¸—à¸µà¹ˆà¸—à¸³à¹ƒà¸«à¹‰à¸­à¸µà¸à¸à¹ˆà¸²à¸¢à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸”à¸µà¸‚à¸¶à¹‰à¸™

à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸‚à¸­à¸‡à¸„à¸¸à¸“à¸„à¸·à¸­:
- à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸§à¹ˆà¸² user à¹ƒà¸Šà¹‰à¹‚à¸—à¸™à¸ à¸²à¸©à¸²à¹à¸šà¸šà¹„à¸«à¸™ à¹€à¸Šà¹ˆà¸™ à¸­à¹ˆà¸­à¸™à¹‚à¸¢à¸™ à¹€à¸«à¹‡à¸™à¹ƒà¸ˆ à¸‚à¸µà¹‰à¹€à¸¥à¹ˆà¸™ à¹€à¸£à¹ˆà¸‡à¹€à¸£à¹‰à¸² à¸«à¸£à¸·à¸­à¸«à¹ˆà¸²à¸‡à¹€à¸«à¸´à¸™
- à¹„à¸¡à¹ˆà¸žà¸¹à¸”à¸–à¸¶à¸‡ "à¹€à¸­à¸¡" à¸«à¸£à¸·à¸­ emmo à¹‚à¸”à¸¢à¸•à¸£à¸‡à¹€à¸”à¹‡à¸”à¸‚à¸²à¸” à¹ƒà¸«à¹‰à¹€à¸™à¹‰à¸™à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¸à¸¶à¸à¸—à¸µà¹ˆà¸—à¸³à¹„à¸”à¹‰à¸”à¸µ
- à¸Šà¸µà¹‰à¹ƒà¸«à¹‰à¹€à¸«à¹‡à¸™à¸§à¹ˆà¸²à¸›à¸£à¸°à¹‚à¸¢à¸„à¹„à¸«à¸™à¸­à¸šà¸­à¸¸à¹ˆà¸™à¹à¸¥à¸°à¸Šà¸§à¸™à¹€à¸›à¸´à¸”à¹ƒà¸ˆ à¸«à¸£à¸·à¸­à¸­à¸²à¸ˆà¹ƒà¸Šà¹‰à¸„à¸³à¸­à¸·à¹ˆà¸™à¹ƒà¸«à¹‰à¹€à¸šà¸²à¹ƒà¸ˆà¸¡à¸²à¸à¸‚à¸¶à¹‰à¸™
- à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹€à¸™à¹‰à¸™à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸„à¸§à¸²à¸¡à¸ªà¸±à¸¡à¸žà¸±à¸™à¸˜à¹Œà¸§à¹ˆà¸²à¸£à¸±à¸à¸à¸±à¸™à¸”à¸µà¹à¸„à¹ˆà¹„à¸«à¸™ à¹à¸•à¹ˆà¹‚à¸Ÿà¸à¸±à¸ªà¸—à¸µà¹ˆà¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰à¸„à¸³à¸žà¸¹à¸”à¹à¸¥à¸°à¸ à¸²à¸©à¸²à¸—à¸µà¹ˆà¸Šà¹ˆà¸§à¸¢à¹€à¸¢à¸µà¸¢à¸§à¸¢à¸²à¹ƒà¸ˆ
- à¹€à¸¥à¸·à¸­à¸à¸›à¸£à¸°à¹‚à¸¢à¸„à¸—à¸µà¹ˆ user à¸žà¸¹à¸”à¹„à¸”à¹‰à¸”à¸µà¸­à¸­à¸à¸¡à¸²à¹€à¸›à¹‡à¸™à¹€à¸«à¸¡à¸·à¸­à¸™ MVP à¸‚à¸­à¸‡à¸šà¸—à¸ªà¸™à¸—à¸™à¸²
- à¸«à¸£à¸·à¸­à¸–à¹‰à¸²à¹€à¸žà¸·à¹ˆà¸­à¸™à¸‚à¸­à¸‡à¹€à¸­à¸¡à¹ƒà¸Šà¹‰à¹‚à¸—à¸™à¹à¸¥à¸°à¸ à¸²à¸©à¸²à¸—à¸µà¹ˆà¸­à¸²à¸ˆà¸ˆà¸°à¸—à¸³à¹ƒà¸«à¹‰à¸­à¸µà¸à¸à¹ˆà¸²à¸¢à¸—à¸µà¹ˆà¸­à¹ˆà¸­à¸™à¹„à¸«à¸§à¸­à¸¢à¸¹à¹ˆà¹à¸¥à¹‰à¸§ à¸£à¸¹à¹‰à¸ªà¸¶à¸à¹à¸¢à¹ˆà¸¥à¸‡à¹„à¸”à¹‰  
  à¸„à¸§à¸£à¸Šà¸µà¹‰à¹ƒà¸«à¹‰à¹€à¸«à¹‡à¸™à¸§à¹ˆà¸²à¸„à¸·à¸­à¸›à¸£à¸°à¹‚à¸¢à¸„à¹„à¸«à¸™ à¹à¸¥à¸°à¸—à¸³à¹„à¸¡à¸ˆà¸¶à¸‡à¹„à¸¡à¹ˆà¸„à¸§à¸£à¸žà¸¹à¸”à¸ªà¸´à¹ˆà¸‡à¸™à¸±à¹‰à¸™  
  à¹‚à¸”à¸¢à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸ˆà¸²à¸ reference list à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡à¸™à¸µà¹‰

à¸„à¸¸à¸“à¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸„à¸³à¸žà¸¹à¸”à¹ƒà¸™à¸šà¸—à¸ªà¸™à¸—à¸™à¸²à¸™à¸µà¹‰à¸à¸±à¸šà¸£à¸²à¸¢à¸à¸²à¸£ reference phrases à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡à¸™à¸µà¹‰  
à¹à¸¡à¹‰à¸„à¸³à¸ˆà¸°à¹€à¸‚à¸µà¸¢à¸™à¹„à¸¡à¹ˆà¹€à¸«à¸¡à¸·à¸­à¸™à¸à¸±à¸™à¹€à¸›à¹Šà¸° à¹à¸•à¹ˆà¸«à¸²à¸à¸„à¸§à¸²à¸¡à¸«à¸¡à¸²à¸¢à¹ƒà¸à¸¥à¹‰à¹€à¸„à¸µà¸¢à¸‡ à¸ªà¸²à¸¡à¸²à¸£à¸–à¸–à¸·à¸­à¸§à¹ˆà¸² match à¹„à¸”à¹‰  
à¹à¸•à¹ˆà¸«à¹‰à¸²à¸¡à¸žà¸¹à¸”à¸–à¸¶à¸‡à¸„à¸³à¸§à¹ˆà¸² reference phrases à¸«à¸£à¸·à¸­à¸­à¸˜à¸´à¸šà¸²à¸¢à¸§à¹ˆà¸²à¸„à¸¸à¸“à¹ƒà¸Šà¹‰ reference à¹ƒà¸™à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹€à¸”à¹‡à¸”à¸‚à¸²à¸”
à¹€à¸žà¸£à¸²à¸°à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¸§à¹ˆà¸²à¸£à¸°à¸šà¸šà¹€à¸šà¸·à¹‰à¸­à¸‡à¸«à¸¥à¸±à¸‡à¸—à¸³à¸‡à¸²à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£ à¹à¸¥à¸°à¸­à¸²à¸ˆà¸—à¸³à¹ƒà¸«à¹‰ feedback à¸”à¸¹à¹€à¸«à¸¡à¸·à¸­à¸™à¸«à¸¸à¹ˆà¸™à¸¢à¸™à¸•à¹Œà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆà¸ˆà¸£à¸´à¸‡à¹ƒà¸ˆ

[reference_phrases]
${JSON.stringify(referencePhrases, null, 2)}

**à¸«à¹‰à¸²à¸¡à¹à¸•à¹ˆà¸‡à¸šà¸—à¸ªà¸™à¸—à¸™à¸²à¹ƒà¸«à¸¡à¹ˆà¹€à¸­à¸‡à¹€à¸”à¹‡à¸”à¸‚à¸²à¸”**  
**à¹ƒà¸«à¹‰à¸­à¸­à¸ feedback à¹€à¸‰à¸žà¸²à¸°à¸ˆà¸²à¸à¸šà¸—à¸ªà¸™à¸—à¸™à¸² JSON à¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸”à¹„à¸§à¹‰à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡à¸™à¸µà¹‰à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™**

[à¸šà¸—à¸ªà¸™à¸—à¸™à¸²]
${JSON.stringify(messages, null, 2)}

à¸‚à¸­à¹ƒà¸«à¹‰à¸„à¸´à¸”à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸à¸²à¸£à¹€à¸‚à¸µà¸¢à¸™ feedback à¸”à¹‰à¸§à¸¢à¸™à¹‰à¸³à¹€à¸ªà¸µà¸¢à¸‡à¹€à¸žà¸·à¹ˆà¸­à¸™à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸¡à¸´à¸•à¸£ à¸­à¸šà¸­à¸¸à¹ˆà¸™ à¹à¸¥à¸°à¹ƒà¸«à¹‰à¸à¸³à¸¥à¸±à¸‡à¹ƒà¸ˆ  
à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£ à¸­à¸²à¸ˆà¸¡à¸µà¸­à¸²à¸£à¸¡à¸“à¹Œà¸‚à¸±à¸™à¹€à¸šà¸² à¹† à¹„à¸”à¹‰ à¸–à¹‰à¸²à¸šà¸£à¸´à¸šà¸—à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡  
à¹€à¸«à¸¡à¸·à¸­à¸™à¸„à¸¸à¸¢à¸à¸±à¸šà¹€à¸žà¸·à¹ˆà¸­à¸™à¸—à¸µà¹ˆà¸à¸³à¸¥à¸±à¸‡à¸«à¸±à¸”à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¹ƒà¸ˆà¸„à¸™à¸­à¸·à¹ˆà¸™à¸­à¸¢à¸¹à¹ˆ â€” à¹à¸šà¸šà¹€à¸›à¹‡à¸™à¹€à¸žà¸·à¹ˆà¸­à¸™à¸—à¸µà¹ˆà¸™à¹ˆà¸²à¸£à¸±à¸à¸—à¸µà¹ˆà¹ƒà¸„à¸£à¸à¹‡à¸­à¸¢à¸²à¸à¸à¸¶à¸à¸à¸±à¸šà¹€à¸˜à¸­

à¹€à¸¡à¸·à¹ˆà¸­à¹„à¸”à¹‰ feedback à¹à¸¥à¹‰à¸§à¸à¸£à¸¸à¸“à¸²à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸•à¸²à¸¡à¸«à¸±à¸§à¸‚à¹‰à¸­à¸•à¹ˆà¸­à¹„à¸›à¸™à¸µà¹‰ à¹‚à¸”à¸¢à¸„à¸³à¸•à¸­à¸šà¸ˆà¸°à¸•à¹‰à¸­à¸‡à¹„à¸¡à¹ˆà¸žà¸¹à¸”à¸–à¸¶à¸‡ "à¹€à¸­à¸¡" à¸«à¸£à¸·à¸­ emmo à¹‚à¸”à¸¢à¸•à¸£à¸‡à¹€à¸”à¹‡à¸”à¸‚à¸²à¸” à¹ƒà¸«à¹‰à¹€à¸™à¹‰à¸™à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¸à¸¶à¸à¸—à¸µà¹ˆà¸—à¸³à¹„à¸”à¹‰à¸”à¸µ (à¹ƒà¸ªà¹ˆà¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸™à¸³à¸«à¸™à¹‰à¸²à¹à¸•à¹ˆà¸¥à¸°à¸‚à¹‰à¸­à¸•à¸²à¸¡à¸¥à¸³à¸”à¸±à¸š à¹à¸¥à¸°à¸‚à¸¶à¹‰à¸™à¸šà¸£à¸£à¸—à¸±à¸”à¹ƒà¸«à¸¡à¹ˆà¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡à¸à¹ˆà¸­à¸™à¸•à¸­à¸šà¸‚à¹‰à¸­à¸–à¸±à¸”à¹„à¸›à¸”à¹‰à¸§à¸¢à¸™à¸°):

1. à¸ˆà¸‡à¹€à¸‚à¸µà¸¢à¸™à¸šà¸—à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸à¸²à¸£à¸•à¸­à¸šà¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¸‡à¸²à¸™à¹ƒà¸™à¹€à¸£à¸·à¹ˆà¸­à¸‡ à¸à¸²à¸£à¹ƒà¸Šà¹‰ â€œà¸„à¸³à¸žà¸¹à¸”à¸—à¸µà¹ˆà¹€à¸«à¹‡à¸™à¹ƒà¸ˆâ€, â€œà¹‚à¸—à¸™à¹€à¸ªà¸µà¸¢à¸‡à¸—à¸µà¹ˆà¸›à¸¥à¸­à¸”à¸ à¸±à¸¢â€, â€œà¸§à¸´à¸˜à¸µà¸žà¸¹à¸”à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸„à¸£â€, tone of speech, empathy, à¹à¸¥à¸°à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¸—à¸µà¹ˆà¸—à¸³à¹ƒà¸«à¹‰à¸­à¸µà¸à¸à¹ˆà¸²à¸¢à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸”à¸µà¸‚à¸¶à¹‰à¸™
2. à¸›à¸£à¸°à¹‚à¸¢à¸„à¸‚à¸­à¸‡ user à¸—à¸µà¹ˆà¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸”
3. à¸—à¸³à¹„à¸¡à¸›à¸£à¸°à¹‚à¸¢à¸„à¸™à¸±à¹‰à¸™à¸–à¸¶à¸‡à¸”à¸µ
4. à¸›à¸£à¸°à¹‚à¸¢à¸„à¸‚à¸­à¸‡ user à¸—à¸µà¹ˆà¸„à¸§à¸£à¸«à¸¥à¸µà¸à¹€à¸¥à¸µà¹ˆà¸¢à¸‡
5. à¸—à¸³à¹„à¸¡à¸›à¸£à¸°à¹‚à¸¢à¸„à¸™à¸±à¹‰à¸™à¸–à¸¶à¸‡à¹„à¸¡à¹ˆà¸„à¸§à¸£à¹ƒà¸Šà¹‰
6. à¸ªà¸£à¸¸à¸› feedback à¸ªà¸±à¹‰à¸™ à¹† à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 140 à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£
7. à¹€à¸‚à¸µà¸¢à¸™ header à¹à¸šà¸š hook (à¸ à¸²à¸©à¸²à¸žà¸¹à¸” à¹†)
8. à¸ˆà¸²à¸à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹ƒà¸«à¹‰à¸„à¸°à¹à¸™à¸™à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¸—à¸µà¹ˆà¸—à¸³à¹ƒà¸«à¹‰à¸­à¸µà¸à¸à¹ˆà¸²à¸¢à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸”à¸µà¸‚à¸¶à¹‰à¸™ à¸•à¸­à¸šà¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚ 1-5 à¹ƒà¸Šà¹‰ format à¸„à¸³à¸•à¸­à¸šà¸§à¹ˆà¸² Score: "{}" à¹‚à¸”à¸¢à¹ƒà¸ªà¹ˆà¸„à¸°à¹à¸™à¸™à¹„à¸§à¹‰à¹ƒà¸™ {} à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸šà¸­à¸à¸„à¸°à¹à¸™à¸™à¹€à¸•à¹‡à¸¡

Guidelines à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¸ªà¸³à¸«à¸£à¸±à¸šà¸«à¸±à¸§à¸‚à¹‰à¸­à¸‚à¹‰à¸­à¸—à¸µà¹ˆ 1:
à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸‚à¸­à¸‡à¸„à¸¸à¸“à¸„à¸·à¸­:
- à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸§à¹ˆà¸² user à¹ƒà¸Šà¹‰à¹‚à¸—à¸™à¸ à¸²à¸©à¸²à¹à¸šà¸šà¹„à¸«à¸™ à¹€à¸Šà¹ˆà¸™ à¸­à¹ˆà¸­à¸™à¹‚à¸¢à¸™ à¹€à¸«à¹‡à¸™à¹ƒà¸ˆ à¸‚à¸µà¹‰à¹€à¸¥à¹ˆà¸™ à¹€à¸£à¹ˆà¸‡à¹€à¸£à¹‰à¸² à¸«à¸£à¸·à¸­à¸«à¹ˆà¸²à¸‡à¹€à¸«à¸´à¸™
- à¹„à¸¡à¹ˆà¸žà¸¹à¸”à¸–à¸¶à¸‡ "à¹€à¸­à¸¡" à¸«à¸£à¸·à¸­ emmo à¹‚à¸”à¸¢à¸•à¸£à¸‡à¹€à¸”à¹‡à¸”à¸‚à¸²à¸” à¹ƒà¸«à¹‰à¹€à¸™à¹‰à¸™à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¸à¸¶à¸à¸—à¸µà¹ˆà¸—à¸³à¹„à¸”à¹‰à¸”à¸µ
- à¸Šà¸µà¹‰à¹ƒà¸«à¹‰à¹€à¸«à¹‡à¸™à¸§à¹ˆà¸²à¸›à¸£à¸°à¹‚à¸¢à¸„à¹„à¸«à¸™à¸­à¸šà¸­à¸¸à¹ˆà¸™à¹à¸¥à¸°à¸Šà¸§à¸™à¹€à¸›à¸´à¸”à¹ƒà¸ˆ à¸«à¸£à¸·à¸­à¸­à¸²à¸ˆà¹ƒà¸Šà¹‰à¸„à¸³à¸­à¸·à¹ˆà¸™à¹ƒà¸«à¹‰à¹€à¸šà¸²à¹ƒà¸ˆà¸¡à¸²à¸à¸‚à¸¶à¹‰à¸™
- à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹€à¸™à¹‰à¸™à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸„à¸§à¸²à¸¡à¸ªà¸±à¸¡à¸žà¸±à¸™à¸˜à¹Œà¸§à¹ˆà¸²à¸£à¸±à¸à¸à¸±à¸™à¸”à¸µà¹à¸„à¹ˆà¹„à¸«à¸™ à¹à¸•à¹ˆà¹‚à¸Ÿà¸à¸±à¸ªà¸—à¸µà¹ˆà¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰à¸„à¸³à¸žà¸¹à¸”à¹à¸¥à¸°à¸ à¸²à¸©à¸²à¸—à¸µà¹ˆà¸Šà¹ˆà¸§à¸¢à¹€à¸¢à¸µà¸¢à¸§à¸¢à¸²à¹ƒà¸ˆ
- à¹€à¸¥à¸·à¸­à¸à¸›à¸£à¸°à¹‚à¸¢à¸„à¸—à¸µà¹ˆ user à¸žà¸¹à¸”à¹„à¸”à¹‰à¸”à¸µà¸­à¸­à¸à¸¡à¸²à¹€à¸›à¹‡à¸™à¹€à¸«à¸¡à¸·à¸­à¸™ MVP à¸‚à¸­à¸‡à¸šà¸—à¸ªà¸™à¸—à¸™à¸²
- à¸«à¸£à¸·à¸­à¸–à¹‰à¸²à¹€à¸žà¸·à¹ˆà¸­à¸™à¸‚à¸­à¸‡à¹€à¸­à¸¡à¹ƒà¸Šà¹‰à¹‚à¸—à¸™à¹à¸¥à¸°à¸ à¸²à¸©à¸²à¸—à¸µà¹ˆà¸­à¸²à¸ˆà¸ˆà¸°à¸—à¸³à¹ƒà¸«à¹‰à¸­à¸µà¸à¸à¹ˆà¸²à¸¢à¸—à¸µà¹ˆà¸­à¹ˆà¸­à¸™à¹„à¸«à¸§à¸­à¸¢à¸¹à¹ˆà¹à¸¥à¹‰à¸§ à¸£à¸¹à¹‰à¸ªà¸¶à¸à¹à¸¢à¹ˆà¸¥à¸‡à¹„à¸”à¹‰  
  à¸„à¸§à¸£à¸Šà¸µà¹‰à¹ƒà¸«à¹‰à¹€à¸«à¹‡à¸™à¸§à¹ˆà¸²à¸„à¸·à¸­à¸›à¸£à¸°à¹‚à¸¢à¸„à¹„à¸«à¸™ à¹à¸¥à¸°à¸—à¸³à¹„à¸¡à¸ˆà¸¶à¸‡à¹„à¸¡à¹ˆà¸„à¸§à¸£à¸žà¸¹à¸”à¸ªà¸´à¹ˆà¸‡à¸™à¸±à¹‰à¸™  
  à¹‚à¸”à¸¢à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸ˆà¸²à¸ reference list à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡à¸™à¸µà¹‰

à¸„à¸¸à¸“à¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸„à¸³à¸žà¸¹à¸”à¹ƒà¸™à¸šà¸—à¸ªà¸™à¸—à¸™à¸²à¸™à¸µà¹‰à¸à¸±à¸šà¸£à¸²à¸¢à¸à¸²à¸£ reference phrases à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡à¸™à¸µà¹‰  
à¹à¸¡à¹‰à¸„à¸³à¸ˆà¸°à¹€à¸‚à¸µà¸¢à¸™à¹„à¸¡à¹ˆà¹€à¸«à¸¡à¸·à¸­à¸™à¸à¸±à¸™à¹€à¸›à¹Šà¸° à¹à¸•à¹ˆà¸«à¸²à¸à¸„à¸§à¸²à¸¡à¸«à¸¡à¸²à¸¢à¹ƒà¸à¸¥à¹‰à¹€à¸„à¸µà¸¢à¸‡ à¸ªà¸²à¸¡à¸²à¸£à¸–à¸–à¸·à¸­à¸§à¹ˆà¸² match à¹„à¸”à¹‰  
à¹à¸•à¹ˆà¸«à¹‰à¸²à¸¡à¸žà¸¹à¸”à¸–à¸¶à¸‡à¸„à¸³à¸§à¹ˆà¸² reference phrases à¸«à¸£à¸·à¸­à¸­à¸˜à¸´à¸šà¸²à¸¢à¸§à¹ˆà¸²à¸„à¸¸à¸“à¹ƒà¸Šà¹‰ reference à¹ƒà¸™à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹€à¸”à¹‡à¸”à¸‚à¸²à¸”
à¹€à¸žà¸£à¸²à¸°à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¸§à¹ˆà¸²à¸£à¸°à¸šà¸šà¹€à¸šà¸·à¹‰à¸­à¸‡à¸«à¸¥à¸±à¸‡à¸—à¸³à¸‡à¸²à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£ à¹à¸¥à¸°à¸­à¸²à¸ˆà¸—à¸³à¹ƒà¸«à¹‰ feedback à¸”à¸¹à¹€à¸«à¸¡à¸·à¸­à¸™à¸«à¸¸à¹ˆà¸™à¸¢à¸™à¸•à¹Œà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆà¸ˆà¸£à¸´à¸‡à¹ƒà¸ˆ

[reference_phrases]
${JSON.stringify(referencePhrases, null, 2)}

Guidelines à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¸ªà¸³à¸«à¸£à¸±à¸šà¸«à¸±à¸§à¸‚à¹‰à¸­à¸‚à¹‰à¸­à¸—à¸µà¹ˆ 7 (Header à¹à¸šà¸š hook):
â€¢	à¸ªà¸±à¹‰à¸™ à¸à¸£à¸°à¸Šà¸±à¸š à¹à¸¥à¸°à¸žà¸¹à¸”à¸à¸±à¸šà¸œà¸¹à¹‰à¸à¸¶à¸à¹‚à¸”à¸¢à¸•à¸£à¸‡ à¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸
â€¢	à¸«à¸¥à¸µà¸à¹€à¸¥à¸µà¹ˆà¸¢à¸‡à¸à¸²à¸£à¸žà¸¹à¸”à¸–à¸¶à¸‡ â€œEmmoâ€ à¸«à¸£à¸·à¸­ â€œà¸šà¸—à¸ªà¸™à¸—à¸™à¸²à¸™à¸µà¹‰â€
â€¢	à¸„à¸§à¸£à¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹ƒà¸«à¹‰à¸à¸³à¸¥à¸±à¸‡à¹ƒà¸ˆà¸«à¸£à¸·à¸­à¸à¸£à¸°à¸•à¸¸à¹‰à¸™ à¹‚à¸”à¸¢à¸ªà¸°à¸—à¹‰à¸­à¸™à¸£à¸°à¸”à¸±à¸šà¸„à¸§à¸²à¸¡à¹€à¸«à¹‡à¸™à¹ƒà¸ˆà¸—à¸µà¹ˆà¸œà¸¹à¹‰à¸à¸¶à¸à¹ƒà¸Šà¹‰
â€¢	à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ style à¸‚à¸­à¸‡ header à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸à¸±à¸šà¸£à¸°à¸”à¸±à¸šà¸„à¸°à¹à¸™à¸™à¸•à¹ˆà¸²à¸‡ à¹†: â€œYou nailed it! So gentle ðŸ’›â€ (à¸„à¸°à¹à¸™à¸™ 5), â€œAlmost perfect! So warm and steady âœ¨â€ (à¸„à¸°à¹à¸™à¸™ 4), â€œà¸”à¸µà¸™à¸° à¹à¸•à¹ˆà¸¢à¸±à¸‡à¸£à¸µà¸šà¹„à¸›à¸™à¸´à¸” à¸¥à¸­à¸‡à¹€à¸šà¸²à¸à¸§à¹ˆà¸²à¸™à¸µà¹‰à¸«à¸™à¹ˆà¸­à¸¢ ðŸ’­â€ (à¸„à¸°à¹à¸™à¸™ 3), â€œNot quite safe yet, but youâ€™re learning ðŸŒ±â€ (à¸„à¸°à¹à¸™à¸™ 2), â€œLetâ€™s pause and reset â€” empathy needs space ðŸ›‘â€ (à¸„à¸°à¹à¸™à¸™ 1)

`;

  try {
    const openaiRes = await axios.post("https://api.openai.com/v1/chat/completions", {
      model: "gpt-4",
      messages: [{ role: "system", content: prompt }],
      temperature: 0.7
    }, {
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`
      }
    });

    const raw = openaiRes.data.choices[0].message.content.trim();
    const lines = raw.split(/\r?\n/).map(line => line.trim()).filter(line => /^\d+\./.test(line));

    const answer1 = lines.find(l => l.startsWith("1."))?.replace(/^1\.\s*/, '') || '';
    const answer2 = lines.find(l => l.startsWith("2."))?.replace(/^2\.\s*/, '') || '';
    const answer3 = lines.find(l => l.startsWith("3."))?.replace(/^3\.\s*/, '') || '';
    const answer4 = lines.find(l => l.startsWith("4."))?.replace(/^4\.\s*/, '') || '';
    const answer5 = lines.find(l => l.startsWith("5."))?.replace(/^5\.\s*/, '') || '';
    const answer6 = lines.find(l => l.startsWith("6."))?.replace(/^6\.\s*/, '') || '';
    const answer7 = lines.find(l => l.startsWith("7."))?.replace(/^7\.\s*/, '') || '';
    const answer8 = lines.find(l => l.startsWith("8."))?.match(/Score:\s*["â€œ]?(\d)["â€]?/)?.[1] || '';

    const feedback = {
      score: Number(answer8),
      header: answer7,
      body: answer6,
      mvp: {
        phrase: answer2,
        why: answer3
      },
      missed: {
        phrase: answer4,
        why: answer5
      },
      full_analysis: answer1,
      feedback_id: "test-feedback-id",
      feedback_url: "https://emmo.life/feedback/test"
    };

    res.json({ feedback });
  } catch (err) {
    console.error("GPT error:", err.message);
    res.status(500).json({ error: "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ" });
  }
});

app.listen(port, () => {
  console.log(`ðŸš€ Emmo backend listening at http://localhost:${port}`);
});
